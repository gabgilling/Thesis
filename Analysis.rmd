---
title: "France Opinion Polls MRP"
author: Gabriel Gilling
---

It seems that MEPs are elected at the NUTS level.

Step 1: Estimating sub-national preferences

Country 1: France
https://en.wikipedia.org/wiki/European_Parliament_constituencies_in_France
2014 ELECTION

EB81.3 Attitudes towards the environment

p7fr_r: NUTS 1 Level

Questions about environment: QA1 to QA18

interesting qs:

QA1: how important is the env? 5pt scale
QA2: what important issues in env ... binary
QA3: knowledge about env 5pt scale -- control variable?
QA12 to QA18


QA18!
Skills and qualifications: QB1 to QB23

qb1: EDUCATION


```{r message=FALSE, warning=FALSE}
options(dplyr.summarise.inform=F) 
library(haven)
library(dplyr)
library(robustHD)
library(ggplot2)
library(forcats)
library(rstanarm)

#v668 IT NUTS 1, v660 FR NUTS 2, v673 NUTS1 UK
#v601 gender v602 age v596 ms

unique(eb75.2$v596)
```

Step 2: Census
```{r}
# census2011_education <- read.csv("https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/census_edu_predictors.csv", header = T)

source("https://raw.githubusercontent.com/gabgilling/Thesis/master/prepare_census.R")
census2011_ms <- read.csv("https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/census_ms_predictors.csv", header = T)

reg_preds <- merge(reg_preds,census2011_ms %>% select(Constituency, Region.Name, country), by = "Region.Name", all.x = TRUE)
# reg_preds$Constituency <-ifelse(is.na(reg_preds$Constituency), reg_preds$Region.Name, reg_preds$Constituency)

reg_preds_constituencies <-  reg_preds %>% group_by(Constituency) %>% 
                                summarise(gdp_cap2 = weighted.mean(gdp_cap, pop),
                                hhd_income2= weighted.mean(hhd_income, pop),
                                unemp_pct2 = weighted.mean(unemp_pct , pop),
                                higher_ed2 = weighted.mean(higher_ed, pop))


reg_preds_constituencies[c("gdp_cap2", "hhd_income2", "unemp_pct2", "higher_ed2")] <- reg_preds_constituencies[c("gdp_cap2", "hhd_income2", "unemp_pct2", "higher_ed2")] %>% robustHD::standardize()

census2011_ms <-merge(census2011_ms, reg_preds_constituencies, by = "Constituency", all.x = T)


```


Step 3: Get regional and country level predictors

https://ec.europa.eu/eurostat/web/regions/data/database

## add marital status 

https://ec.europa.eu/eurostat/web/rural-development/data

https://www.gesis.org/en/eurobarometer-data-service/search-data-access/topics
https://www.kaggle.com/ruslankl/european-union-lgbt-survey-2012?select=LGBT_Survey_Discrimination.csv

## is having more regional predictors than individual predictors OK?

try to minimize amounts of regional predictors, maybe 2-3

```{r estimate_preferences}

set.seed(1010)



eb75.2 %>% group_by(NUTS_eb) %>% summarise(mean(eu.leg, na.rm = T))



rbind(eb75.2 %>% select(protect.env, age_cat2, gender_male, ms, NUTS_eb), eb81.3 %>% select(protect.env, age_cat2, gender_male, ms, NUTS_eb)) %>% group_by(age_cat2, gender_male, ms, NUTS_eb) %>%
  summarise(pro = sum(get(var_name) == 1), against = n() - pro) %>% na.omit()
```


```{r}
source("/Users/gabgilling/Documents/Documents - Gabrielâ€™s MacBook Pro/GitHub/Thesis/wrange_eb.R")

fit_var_logit <- function(survey_df = c(), var_name, regional_predictors){
  # print(length(survey_df))
  if (length(survey_df) >= 2){
    
    temp <- get(survey_df[1]) %>% select(var_name, age_cat2, gender_male, ms, NUTS_eb)
    for (i in 2:length(survey_df)){
      temp <- rbind(temp, get(survey_df[i]) %>% select(var_name, age_cat2, gender_male, ms, NUTS_eb))
    }
  } else {
    temp = get(survey_df)
  }
  

  temp <- merge(temp, regional_predictors, by = "Constituency", all.x = T)

  temp <- temp %>% group_by(age_cat2, gender_male, ms, Constituency, country, gdp_cap2, 
                            higher_ed2,hhd_income2, unemp_pct2) %>%
                            summarise(pro = sum(get(var_name) == 1), against = n() - pro) %>% 
                            na.omit()
  
  set.seed(1010)

  return(stan_glmer(cbind(pro, against) ~ (1|country) + (1|Constituency) + (1 | age_cat2)  + (1|ms) + gdp_cap2  + unemp_pct2 + gender_male, data = temp, family = binomial(link = "logit"), refresh= 0, 
                    chains = 4, cores=  4, adapt_delta= 0.99))

}



generate_estimates <- function(survey_df){
  excl <- c("gender_male", "age_cat2", "ms" , "year","parliament", "country",
            "Region.Name", "Constituency", "NUTS_eb_old", "NUTS_eb_new")
  
  my_list <- list()
  i <- 1
  for (col in colnames(get(survey_df))[!colnames(get(survey_df)) %in% excl]){
    print(col)
    my_list[[i]] <- fit_var_logit(survey_df = survey_df, var_name = col, 
                                  regional_predictors = reg_preds_constituencies)
    i <- i + 1
  }
  return(my_list)
}

fit.692 <- generate_estimates("eb69.2")
fit.813 <- generate_estimates("eb81.3")
fit.752 <- generate_estimates("eb75.2")
fit.621 <- generate_estimates("eb62.1")

fit.621_noed <- generate_estimates("eb62.1")
fit.621_noed_nohhd <- generate_estimates("eb62.1")

fit.682 <- generate_estimates("eb68.2")
fit.711 <- generate_estimates("eb71.1")
fit.721 <- generate_estimates("eb72.1")
fit.752 <- generate_estimates("eb75.2")

fit.802 <- generate_estimates("eb80.2")
fit.834 <- generate_estimates("eb83.4")

fit.871 <- generate_estimates("eb87.1")

fit.881 <- generate_estimates("eb88.1")
fit.902 <- generate_estimates("eb90.2")


set.seed(1011)
fit.692[[8]] <- fit_var_logit(survey_df = c("eb69.2"), var_name = "ghgtarget")

set.seed(1011)
fit_var_logit(survey_df = c("eb88.1"), var_name = "env.important", reg_preds_constituencies)

print(fit.protect.env, digits = 3)
```

```{r poststratify}
census2011_ms$isocntry <- census2011_ms$country

generate_region_estimates <- function(poststrat, fitted_model){
  
  ## generate state_df
  N <- length(unique(poststrat$Constituency))
  
  region_preferences <- data.frame(
                          Constituency = unique(poststrat$Constituency),
                          country = rep("", N),
                          pref = rep(-1, N),
                          se = rep(-1, N)
)

  for (i in unique(poststrat$Constituency)) {
    # print(i)
    poststrat_region <- poststrat[poststrat$Constituency == i, ] %>% na.omit()
    
    posterior_prob_region <- posterior_epred(
      fitted_model,
      # transform = TRUE,
      draws = 1000,
      newdata = as.data.frame(poststrat_region)
    )
    
    poststrat_prob_region <- posterior_prob_region %*% poststrat_region$freq / sum(poststrat_region$freq)

    #This is the estimate for popn in state:
    region_preferences[region_preferences$Constituency == i,]$pref <- round(mean(poststrat_prob_region), 4)
    region_preferences[region_preferences$Constituency == i,]$se <- round(sd(poststrat_prob_region), 4)
    region_preferences[region_preferences$Constituency == i,]$country <- unique(poststrat_region$isocntry)
  }
  
  # return(region_preferences %>% group_by(Constituency, country) %>% summarise(pref = mean(pref), se = mean(se)))
  return(region_preferences)
}

poststrat_survey <- function(model_list){
  survey_prefs <- list()
  agg_results <- generate_region_estimates(poststrat = census2011_ms %>%  na.omit(), model_list[[1]])
  survey_prefs[[1]] <- agg_results
  for (i in 2:length(model_list)){
    print(i)
    res <- generate_region_estimates(poststrat = census2011_ms %>%  na.omit(), model_list[[i]])
    survey_prefs[[i]] <- res
    agg_results <- rbind(agg_results, res)
  }
  
  agg_prefs <- as.data.frame(agg_results %>% group_by(Constituency, country) %>%summarise(mean_pref = mean(pref), mean_se = mean(se)))
  
  
  
  return(list(agg_prefs, survey_prefs))
}

# skip 6th model too high diverg trans
prefs.621 <- poststrat_survey(fit.621[-6])
prefs.621_noed <- poststrat_survey(fit.621_noed)
prefs.621_noed_nohhd <- poststrat_survey(fit.621_noed_nohhd)
prefs.692 <- poststrat_survey(fit.692)
prefs.813 <- poststrat_survey(fit.813)
prefs.752 <- poststrat_survey(fit.752)
prefs.682 <- poststrat_survey(fit.682)

prefs.711 <- poststrat_survey(fit.711)
prefs.721 <- poststrat_survey(fit.721)
prefs.752 <- poststrat_survey(fit.752)
prefs.802 <- poststrat_survey(fit.802)
prefs.834 <- poststrat_survey(fit.834)
prefs.871 <- poststrat_survey(fit.871)
# skip first model too high diverg trans
prefs.881 <- poststrat_survey(fit.881[-1])
prefs.902 <- poststrat_survey(fit.902)

total.prefs <- rbind(prefs.621[[1]],prefs.692[[1]], prefs.813[[1]], prefs.752[[1]], prefs.682[[1]], prefs.711[[1]],
                     prefs.721[[1]],prefs.752[[1]], prefs.802[[1]], prefs.834[[1]], prefs.871[[1]], prefs.881[[1]]) %>% 
                group_by(Constituency, country) %>% 
                summarise(mean_pref = mean(mean_pref), mean_se = mean(mean_se))



env_prefs_plot <- ggplot(prefs.621[[2]][[4]],
                         aes(x= reorder(Constituency, pref), y = pref, color = country)) + 
  geom_point() + 
  # geom_errorbar(aes(ymin= mean_pref - mean_se, ymax= mean_pref + mean_se), width=0) + 
  theme_classic() +
  ylim(0.2, 1.1) +
  ggtitle("") +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Constituency", y = "Mean Preference")

env_prefs_plot

# ggsave("/Users/gabgilling/Documents/GitHub/Thesis/Plots/env_prefs_plot.jpg")

```

```{r}
colnames(eb62.1)
excl <- c("gender_male", "age_cat2", "ms" , "year","parliament", "country",
            "Region.Name", "Constituency", "NUTS_eb_old", "NUTS_eb_new", "Constituency")

t <- na.omit(eb62.1) %>% group_by(Constituency, country) %>% 
                summarise_at(colnames(eb62.1[!colnames(eb62.1) %in% excl]), mean)
t <- t[-8]

t

ggplot(cbind(t[c(1:2)], mean_prefs = t[-c(1:2)] %>% rowMeans()), aes( x= Constituency, y = mean_prefs)) + 
  geom_point() +   theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Constituency", y = "Mean Preference") 

```
```{r}
ggplot(prefs.621[[1]], aes(x = Constituency, y= mean_pref)) + geom_point() +   theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Constituency", y = "Mean Preference") 

```



```{r}
ggplot(protect.envs_prefs.r2,
  aes(x= reorder(constituency, pref), y = pref, color = country)) + 
  geom_point() + 
  geom_errorbar(aes(ymin= pref - se, ymax= pref + se), width=0) + 
  theme_classic() +
  # ylim(0.6, 1) + 
  ggtitle("") +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Constituency", y = "Mean Preference")
```

I. Get regional level roll call votes. Need to figure out what roll call votes can be correlated to regional level preferences

votewatch.eu/en/term9-european-parliament-latest-votes.html

https://mepsurvey.eu/data-objects/data/

# MEP Survey data

```{r}
mep.ids <- read.csv("https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/mep_data_with_IDs.csv")
```

# T4-0084/1995

Final votes tabulated as "Proposition"
Amendments - "Am"

tabulate parliament group activities as additional control

need to adjust for fact that some MEPs were not in parliament at that time

```{r}
# install.packages("rjson")
library(rjson)
MEP.data <- fromJSON(file = "/Users/gabgilling/Dropbox/QMSS/Fall 2020/Thesis/Data/ep_votes.json")


cond <- sapply(MEP.data, function(x) grepl("A8-0287/2016", x$title))

cond <- sapply(MEP.data, function(x) grepl("envir", x$title))

cond.ts <- sapply(MEP.data, function(x) grepl("2018-11", x$ts))

#A8-0354/2018 CO2 emission performance standards for new heavy duty vehicles ***I	
cond1 <- sapply(MEP.data, function(x) grepl("A8-0354/2018", x$title))
dat <- MEP.data[cond1]
cond2 <- sapply(dat, function(x) grepl("Proposition", x$title))
A8.0354 <- dat[cond2][[1]]

#A8-0249/2015 reduction of national emissions of certain atmospheric pollutants
#https://www.europarl.europa.eu/doceo/document/TA-8-2016-0438_EN.html

cond1 <- sapply(MEP.data, function(x) grepl("A8-0249/2015", x$title))
dat <- MEP.data[cond1]
cond2 <- sapply(dat, function(x) grepl("RÃ©solution", x$title))
A8.0249 <- dat[cond2][[1]]

#A8-0317/2018 
#reduction of the impact of certain plastic products on the environment
#https://www.europarl.europa.eu/doceo/document/A-8-2018-0317_EN.html

# A7-0294/2012
# establishment of a Programme for the Environment and Climate Action (LIFE)
# https://www.europarl.europa.eu/doceo/document/A-7-2012-0294_EN.html?redirect

# https://eur-lex.europa.eu/legal-content/en/HIS/?uri=CELEX:32008L0050
```

```{r}

count_votes <- function(resolution_name, col_name){
  mep.ids[col_name] <- 0
  # print(get(resolution_name))
  resolution = get(resolution_name)
  for (i in resolution$votes$`+`$groups){
    for (id in unname(unlist(i))){
      if (id %in% unique(mep.ids$ID)){
        mep.ids[mep.ids$ID == id,][col_name] <- 1
      }
    }
  }
  
  for (i in resolution$votes$`-`$groups){
    for (id in unname(unlist(i))){
      if (id %in% unique(mep.ids$ID)){
        mep.ids[mep.ids$ID == id,][col_name]- -1
      }
    }
  }
  return(mep.ids)
}

mep.ids$env1 <- 0
mep.ids$env2 <- 0

mep.ids <- count_votes(resolution_name = "A8.0249", "env2")
mep.ids <- count_votes(resolution_name = "A8.0354", "env1")

mep.ids$env1 <- with(mep.ids, ifelse(Parliament != 8, NA, env1))
mep.ids$env2 <- with(mep.ids, ifelse(Parliament != 8, NA, env2))

```


```{r}
ggplot(mep.ids %>% group_by(constituency, Parliament, country) %>% 
       summarise(mep_pref = mean(env1+env2), mep_se = sd(env1+env2) / sqrt(length(env1+env2))) %>% na.omit(), 
       aes(x = constituency, y = mep_pref, color = country)) + 
  geom_point() + 
  geom_errorbar(aes(ymin= mep_pref - mep_se, ymax= mep_pref + mep_se), width=0) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90))
```

```{r warning=FALSE}
library(rgdal)
library(broom)
library(maptools)
library(ggplot2)

# install.packages('rgeos', type='source')
# install.packages('rgdal', type='source')

NUTS_shape = readOGR(dsn = "/Users/gabgilling/Desktop/NUTS_2013_01M_SH/data/")

NUTS_shape2 = readOGR(dsn = "/Users/gabgilling/Desktop/NUTS_2013_01M_SH/data/", layer = "NUTS_RG_01M_2013")

nuts <- readOGR(dsn = "/Users/gabgilling/Desktop/NUTS_2013_01M_SH/data/NUTS_RG_01M_2013.shp")

nuts <- nuts[nuts$STAT_LEVL_ %in% c(1,2),]
nuts <- nuts[grepl("FR|UK|IT",nuts$NUTS_ID),]

# plot(nuts)
shp_df <- fortify(nuts, region = "NUTS_ID")

shp_df <- shp_df %>% filter(id %in% c("FR", "UK", "IT"))

# NUTS_shape2@data$LAT <- NUTS_shape@data$LAT
# NUTS_shape2@data$LON <- NUTS_shape@data$LON
# 
# NUTS_fort <- tidy(NUTS_shape)
ggplot() + geom_polygon(data= shp_df, aes(x = long, y = lat, group = group, color = id))

plot(NUTS_shape)
```

