---
title: "France Opinion Polls MRP"
author: Gabriel Gilling
---

It seems that MEPs are elected at the NUTS level.

Step 1: Estimating sub-national preferences

Country 1: France
https://en.wikipedia.org/wiki/European_Parliament_constituencies_in_France
2014 ELECTION

EB81.3 Attitudes towards the environment

p7fr_r: NUTS 1 Level

Questions about environment: QA1 to QA18

interesting qs:

QA1: how important is the env? 5pt scale
QA2: what important issues in env ... binary
QA3: knowledge about env 5pt scale -- control variable?
QA12 to QA18


QA18!
Skills and qualifications: QB1 to QB23

qb1: EDUCATION


```{r}
options(dplyr.summarise.inform=F) 
library(haven)
library(dplyr)
library(robustHD)
library(ggplot2)
library(forcats)

eb81.3 <- read_dta("/Users/gabgilling/Downloads/ZA5914_v3-0-0.dta")

eb81.3$gender_male <- ifelse(eb81.3$d10 == 2, 1, 0)

# for education census
eb81.3$age_cat1 <- with(eb81.3, ifelse(d11 >= 18 & d11 < 25, "Y18-24",
                               ifelse(d11 >= 25 & d11 < 30, "Y25-29",
                               ifelse( d11 >= 30 & d11 < 50, "Y30-49",
                                      ifelse(d11 >= 50 & d11 < 65, "Y50-64",
                                      ifelse(d11 >= 65 & d11 < 85, "Y65-84",
                                      ifelse(d11 >= 85, "Y_GE85",
                                      NA)))))))
# for marital status census
eb81.3$age_cat2 <- with(eb81.3, ifelse(d11 >= 15 & d11 < 30, "Y15-29",
                               ifelse(d11 >= 30 & d11 < 50, "Y30-49",
                               ifelse( d11 >= 50 & d11 < 65, "Y50-64",
                                      ifelse(d11 >= 65 & d11 < 85, "Y65-84",
                                      ifelse(d11 >= 85, "Y_GE85",
                                      NA))))))

eb81.3$ms <- with(eb81.3, ifelse(d7 %in% c(1,2,3,4), "MAR",
                          ifelse(d7 %in% c(5,6,7,8), "REP",
                          ifelse(d7 %in% c(9,10), "SIN",
                          ifelse(d7 %in% c(11,12), "DIV",
                          ifelse(d7 %in% c(13,14), "WID",
                          NA))))))
                                      
                                      
eb81.3$edu <- eb81.3$qb1

eb81.3$NUTS_eb <- with(eb81.3, ifelse(isocntry == "FR", paste("FR", eb81.3$p7fr, sep = ""), 
                      ifelse(isocntry %in% c("GB-GBN", "GB-NIR"), paste("UK", eb81.3$p7gb, sep = ""),
                      ifelse(isocntry == "IT", paste("IT", eb81.3$p7it_r1, sep = ""), NA))))


eb81.3_filt <- eb81.3 %>% filter (isocntry %in% c('FR', 'GB-GBN', "GB-NIR", 'IT'))

eb75.2 <- read_dta("/Users/gabgilling/Downloads/ZA5480_v4-0-1.dta")

eb75.2 <- eb75.2 %>% filter(v7 %in% c("GB-GBN", "FR", "IT"))

#v668 IT NUTS 1, v660 FR NUTS 2, v673 NUTS1 UK
#v601 gender v602 age



```

Step 2: Census
```{r}
source("/Users/gabgilling/Documents/GitHub/Thesis/prepare_census.R")
```


Step 3: Get regional and country level predictors

https://ec.europa.eu/eurostat/web/regions/data/database

## add marital status 

https://ec.europa.eu/eurostat/web/rural-development/data

https://www.gesis.org/en/eurobarometer-data-service/search-data-access/topics
https://www.kaggle.com/ruslankl/european-union-lgbt-survey-2012?select=LGBT_Survey_Discrimination.csv

## is having more regional predictors than individual predictors OK?

try to minimize amounts of regional predictors, maybe 2-3

```{r estimate_preferences}
library(rstanarm)

eb81.3_filt$eu.leg <- ifelse(eb81.3_filt$qa18_1 %in% c(1,2), 1, ifelse(eb81.3_filt$qa18_1 %in% c(3,4), 0, NA))
eb81.3_filt$eu.enf <- ifelse(eb81.3_filt$qa18_2 %in% c(1,2), 1, ifelse(eb81.3_filt$qa18_2 %in% c(3,4), 0, NA))
eb81.3_filt$eu.asst <- ifelse(eb81.3_filt$qa18_3 %in% c(1,2), 1, ifelse(eb81.3_filt$qa18_3 %in% c(3,4), 0, NA))
eb81.3_filt$eu.fund <- ifelse(eb81.3_filt$qa18_4 %in% c(1,2), 1, ifelse(eb81.3_filt$qa18_4 %in% c(3,4), 0, NA))
eb81.3_filt$cooperation <- ifelse(eb81.3_filt$qa15 == 2, 1, ifelse(eb81.3_filt$qa15 == 1, 0, NA))
eb81.3_filt$envorecon <- ifelse(eb81.3_filt$qa14 == 1, 1, ifelse(eb81.3_filt$qa15 == 2, 0, NA))

eb81.3_filt$protect.env <- ifelse(eb81.3_filt$qa1 %in% c(1,2), 1, ifelse(eb81.3_filt$qa1 %in% c(3,4), 0, NA))

protect.env <- eb81.3_filt %>% group_by(age_cat, gender_male, edu, NUTS_eb) %>%
  summarise(pro = sum(protect.env == 1), against = n() - pro) %>% na.omit()
protect.env <- merge(protect.env, reg_preds_std, by = "NUTS_eb")
protect.env$country <- substr(protect.env$NUTS, 1, 2)
protect.env<- merge(protect.env, nuts_fr %>% select(Constituency, Region.Name), by = "Region.Name", all.x = TRUE)
protect.env$Constituency <- ifelse(is.na(protect.env$Constituency), protect.env$Region.Name, protect.env$Constituency)

eu.leg <- eb81.3_filt %>% group_by(age_cat, gender_male, edu, NUTS_eb) %>%
  summarise(pro = sum(eu.leg == 1), against = n() - pro) %>% na.omit()
eu.leg <- merge(eu.leg, reg_preds_std, by = "NUTS_eb")
eu.leg$country <- substr(eu.leg$NUTS, 1, 2)
eu.leg<- merge(eu.leg, nuts_fr %>% select(Constituency, Region.Name), by = "Region.Name", all.x = TRUE)
eu.leg$Constituency <- ifelse(is.na(eu.leg$Constituency), eu.leg$Region.Name, eu.leg$Constituency)

eu.enf <- eb81.3_filt %>% group_by(age_cat, gender_male, edu, NUTS_eb) %>%
  summarise(pro = sum(eu.enf == 1), against = n() - pro) %>% na.omit()
eu.enf <- merge(eu.enf, reg_preds_std, by = "NUTS_eb")
eu.enf$country <- substr(eu.enf$NUTS, 1, 2)
eu.enf<- merge(eu.enf, nuts_fr %>% select(Constituency, Region.Name), by = "Region.Name", all.x = TRUE)
eu.enf$Constituency <- ifelse(is.na(eu.enf$Constituency), eu.enf$Region.Name, eu.enf$Constituency)

eu.asst <- eb81.3_filt %>% group_by(age_cat, gender_male, edu, NUTS_eb) %>%
  summarise(pro = sum(eu.asst == 1), against = n() - pro) %>% na.omit()

eu.asst <- merge(eu.asst, reg_preds_std, by = "NUTS_eb")
eu.asst$country <- substr(eu.asst$NUTS, 1, 2)
eu.asst<- merge(eu.asst, nuts_fr %>% select(Constituency, Region.Name), by = "Region.Name", all.x = TRUE)
eu.asst$Constituency <- ifelse(is.na(eu.asst$Constituency), eu.asst$Region.Name, eu.enf$Constituency)

eu.fund <- eb81.3_filt %>% group_by(age_cat, gender_male, edu, NUTS_eb) %>%
  summarise(pro = sum(eu.fund == 1), against = n() - pro) %>% na.omit()

eu.fund <- merge(eu.fund, reg_preds_std, by = "NUTS_eb")
eu.fund$country <- substr(eu.fund$NUTS, 1, 2)
eu.fund<- merge(eu.fund, nuts_fr %>% select(Constituency, Region.Name), by = "Region.Name", all.x = TRUE)
eu.fund$Constituency <- ifelse(is.na(eu.fund$Constituency), eu.fund$Region.Name, eu.enf$Constituency)

cooperation <- eb81.3_filt %>% group_by(age_cat, gender_male, edu, NUTS_eb) %>%
  summarise(pro = sum(cooperation == 1), against = n() - pro) %>% na.omit()

cooperation <- merge(cooperation, reg_preds_std, by = "NUTS_eb")
cooperation$country <- substr(cooperation$NUTS, 1, 2)
cooperation<- merge(cooperation, nuts_fr %>% select(Constituency, Region.Name), by = "Region.Name", all.x = TRUE)
cooperation$Constituency <- ifelse(is.na(cooperation$Constituency), cooperation$Region.Name, cooperation$Constituency)

envorecon <- eb81.3_filt %>% group_by(age_cat, gender_male, edu, NUTS_eb) %>%
  summarise(pro = sum(envorecon == 1), against = n() - pro) %>% na.omit()

envorecon <- merge(envorecon, reg_preds_std, by = "NUTS_eb")
envorecon$country <- substr(envorecon$NUTS, 1, 2)
envorecon<- merge(envorecon, nuts_fr %>% select(Constituency, Region.Name), by = "Region.Name", all.x = TRUE)
envorecon$Constituency <- ifelse(is.na(envorecon$Constituency), envorecon$Region.Name, envorecon$Constituency)

fit.protect.env <- stan_glmer(cbind(pro, against) ~ (1|country) + (1|NUTS_eb) + (1 | age_cat)  + (1|edu) + gdp_cap + higher_ed + hhd_income + unemp_pct + gender_male, data = protect.env, family = binomial(link = "logit"), refresh= 0)

fit.eu.leg <- stan_glmer(cbind(pro, against) ~ (1|country) + (1|NUTS_eb) + (1 | age_cat)  + (1|edu) + gdp_cap + higher_ed + hhd_income + unemp_pct + gender_male, data = eu.leg, family = binomial(link = "logit"), refresh= 0)

fit.eu.enf <- stan_glmer(cbind(pro, against) ~ (1|country) + (1|NUTS_eb) + (1 | age_cat)  + (1|edu) + gdp_cap + higher_ed + hhd_income + unemp_pct + gender_male, data = eu.enf, family = binomial(link = "logit"), refresh= 0)

fit.eu.asst <- stan_glmer(cbind(pro, against) ~ (1|country) + (1|NUTS_eb) + (1 | age_cat)  + (1|edu) + gdp_cap + higher_ed + hhd_income + unemp_pct + gender_male, data = eu.asst, family = binomial(link = "logit"), refresh= 0)

fit.eu.fund <- stan_glmer(cbind(pro, against) ~ (1|country) + (1|NUTS_eb) + (1 | age_cat)  + (1|edu) + gdp_cap + higher_ed + hhd_income + unemp_pct + gender_male, data = eu.fund, family = binomial(link = "logit"), refresh= 0)

fit.cooperation <- stan_glmer(cbind(pro, against) ~ (1|country) + (1|NUTS_eb) + (1 | age_cat)  + (1|edu) + gdp_cap + higher_ed + hhd_income + unemp_pct + gender_male, data = cooperation, family = binomial(link = "logit"), refresh= 0)

fit.envorecon <- stan_glmer(cbind(pro, against) ~ (1|country) + (1|NUTS_eb) + (1 | age_cat)  + (1|edu) + gdp_cap + higher_ed + hhd_income + unemp_pct + gender_male, data = envorecon, family = binomial(link = "logit"), refresh= 0)


print(fit.protect.env, digits = 3)
```


```{r poststratify}

generate_region_estimates <- function(poststrat, fitted_model){
  
  ## generate state_df
  N <- length(unique(poststrat$Region.Name))
  
  region_preferences <- data.frame(
                          Region.Name = unique(poststrat$Region.Name),
                          constituency = rep("", N),
                          country = rep("", N),
                          pref = rep(-1, N),
                          se = rep(-1, N)
)

  for (i in unique(poststrat$Region.Name)) {
    print(i)
    poststrat_region <- poststrat[poststrat$Region.Name == i, ]
    
    posterior_prob_region <- posterior_epred(
      fitted_model,
      # transform = TRUE,
      draws = 1000,
      newdata = as.data.frame(poststrat_region)
    )
    
    poststrat_prob_region <- posterior_prob_region %*% poststrat_region$freq / sum(poststrat_region$freq)

    #This is the estimate for popn in state:
    region_preferences[region_preferences$Region.Name == i,]$pref <- round(mean(poststrat_prob_region), 4)
    region_preferences[region_preferences$Region.Name == i,]$se <- round(sd(poststrat_prob_region), 4)
    region_preferences[region_preferences$Region.Name == i,]$country <- unique(poststrat_region$country)
    region_preferences[region_preferences$Region.Name == i,]$constituency <- unique(poststrat_region$Constituency)
  }
  return(region_preferences)
}


protect.env_prefs <- generate_region_estimates(poststrat = census2011_education %>%  na.omit(), fit.protect.env)
envorecon_prefs <- generate_region_estimates(poststrat = census2011_education %>%  na.omit(), fit.envorecon)
cooperation_prefs <- generate_region_estimates(poststrat = census2011_education %>%  na.omit(), fit.cooperation)
eu.asst_prefs <- generate_region_estimates(poststrat = census2011_education %>%  na.omit(), fit.eu.asst)
eu.enf_prefs <- generate_region_estimates(poststrat = census2011_education %>%  na.omit(), fit.eu.enf)
eu.fund_prefs <- generate_region_estimates(poststrat = census2011_education %>%  na.omit(), fit.eu.fund)
eu.leg_prefs <- generate_region_estimates(poststrat = census2011_education %>%  na.omit(), fit.eu.leg)

protect.envs_prefs.r <- protect.env_prefs %>% group_by(constituency, country) %>% summarise(pref = mean(pref), se = mean(se))
envorecon_prefs.r <- envorecon_prefs%>% group_by(constituency, country) %>% summarise(pref = mean(pref), se = mean(se))
cooperation_prefs.r <- cooperation_prefs%>% group_by(constituency, country) %>% summarise(pref = mean(pref), se = mean(se))
eu.asst_prefs.r <- eu.asst_prefs%>% group_by(constituency, country) %>% summarise(pref = mean(pref), se = mean(se))
eu.enf_prefs.r <- eu.enf_prefs%>% group_by(constituency, country) %>% summarise(pref = mean(pref), se = mean(se))
eu.fund_prefs.r <- eu.fund_prefs%>% group_by(constituency, country) %>% summarise(pref = mean(pref), se = mean(se))
eu.leg_prefs.r <- eu.leg_prefs%>% group_by(constituency, country) %>% summarise(pref = mean(pref), se = mean(se))

agg_prefs <- rbind(protect.envs_prefs.r,envorecon_prefs.r,cooperation_prefs.r,eu.asst_prefs.r,eu.enf_prefs.r,eu.fund_prefs.r,eu.leg_prefs.r) %>% group_by(constituency, country) %>%  summarise(mean_pref = mean(pref), mean_se = mean(se))


env_prefs_plot <- ggplot(agg_prefs,
                         aes(x= reorder(constituency, mean_pref), y = mean_pref, color = country)) + 
  geom_point() + 
  geom_errorbar(aes(ymin= mean_pref - mean_se, ymax= mean_pref + mean_se), width=0) + 
  theme_classic() +
  # ylim(0.6, 1) + 
  ggtitle("") +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Constituency", y = "Mean Preference")

env_prefs_plot

# ggsave("/Users/gabgilling/Documents/GitHub/Thesis/Plots/env_prefs_plot.jpg")

```


I. Get regional level roll call votes. Need to figure out what roll call votes can be correlated to regional level preferences

votewatch.eu/en/term9-european-parliament-latest-votes.html

https://mepsurvey.eu/data-objects/data/

# MEP Survey data

```{r}
mep.ids <- read.csv("https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/mep_data_with_IDs.csv")
```

# T4-0084/1995

Final votes tabulated as "Proposition"
Amendments - "Am"

tabulate parliament group activities as additional control

need to adjust for fact that some MEPs were not in parliament at that time

```{r}
# install.packages("rjson")
library(rjson)
MEP.data <- fromJSON(file = "/Users/gabgilling/Dropbox/QMSS/Fall 2020/Thesis/Data/ep_votes.json")

grepl("A6", MEP.data[[5]]$title)

cond <- sapply(MEP.data, function(x) grepl("A8-0287/2016", x$title))

cond <- sapply(MEP.data, function(x) grepl("envir", x$title))

cond.ts <- sapply(MEP.data, function(x) grepl("2018-11", x$ts))

#A8-0354/2018 CO2 emission performance standards for new heavy duty vehicles ***I	
cond1 <- sapply(MEP.data, function(x) grepl("A8-0354/2018", x$title))
dat <- MEP.data[cond1]
cond2 <- sapply(dat, function(x) grepl("Proposition", x$title))
A8.0354 <- dat[cond2][[1]]

#A8-0249/2015 reduction of national emissions of certain atmospheric pollutants
#https://www.europarl.europa.eu/doceo/document/TA-8-2016-0438_EN.html

cond1 <- sapply(MEP.data, function(x) grepl("A8-0249/2015", x$title))
dat <- MEP.data[cond1]
cond2 <- sapply(dat, function(x) grepl("RÃ©solution", x$title))
A8.0249 <- dat[cond2][[1]]

#A8-0317/2018 
#reduction of the impact of certain plastic products on the environment
#https://www.europarl.europa.eu/doceo/document/A-8-2018-0317_EN.html

# A7-0294/2012
# establishment of a Programme for the Environment and Climate Action (LIFE)
# https://www.europarl.europa.eu/doceo/document/A-7-2012-0294_EN.html?redirect

# https://eur-lex.europa.eu/legal-content/en/HIS/?uri=CELEX:32008L0050
```

```{r}

count_votes <- function(resolution_name, col_name){
  mep.ids[col_name] <- 0
  # print(get(resolution_name))
  resolution = get(resolution_name)
  for (i in resolution$votes$`+`$groups){
    for (id in unname(unlist(i))){
      if (id %in% unique(mep.ids$ID)){
        mep.ids[mep.ids$ID == id,][col_name] <- 1
      }
    }
  }
  
  for (i in resolution$votes$`-`$groups){
    for (id in unname(unlist(i))){
      if (id %in% unique(mep.ids$ID)){
        mep.ids[mep.ids$ID == id,][col_name]- -1
      }
    }
  }
  return(mep.ids)
}

mep.ids$env1 <- 0
mep.ids$env2 <- 0

mep.ids <- count_votes(resolution_name = "A8.0249", "env2")
mep.ids <- count_votes(resolution_name = "A8.0354", "env1")

mep.ids$env1 <- with(mep.ids, ifelse(Parliament != 8, NA, env1))
mep.ids$env2 <- with(mep.ids, ifelse(Parliament != 8, NA, env2))

```


```{r}
ggplot(mep.ids %>% group_by(constituency, Parliament, country) %>% 
       summarise(mep_pref = mean(env1+env2), mep_se = sd(env1+env2) / sqrt(length(env1+env2))) %>% na.omit(), 
       aes(x = constituency, y = mep_pref, color = country)) + 
  geom_point() + 
  geom_errorbar(aes(ymin= mep_pref - mep_se, ymax= mep_pref + mep_se), width=0) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90))
```

```{r warning=FALSE}
library(rgdal)
library(broom)
library(maptools)
library(ggplot2)

# install.packages('rgeos', type='source')
# install.packages('rgdal', type='source')

NUTS_shape = readOGR(dsn = "/Users/gabgilling/Desktop/NUTS_2013_01M_SH/data/")

NUTS_shape2 = readOGR(dsn = "/Users/gabgilling/Desktop/NUTS_2013_01M_SH/data/", layer = "NUTS_RG_01M_2013")

nuts <- readOGR(dsn = "/Users/gabgilling/Desktop/NUTS_2013_01M_SH/data/NUTS_RG_01M_2013.shp")

nuts <- nuts[nuts$STAT_LEVL_ %in% c(1,2),]
nuts <- nuts[grepl("FR|UK|IT",nuts$NUTS_ID),]

# plot(nuts)
shp_df <- fortify(nuts, region = "NUTS_ID")

shp_df <- shp_df %>% filter(id %in% c("FR", "UK", "IT"))

# NUTS_shape2@data$LAT <- NUTS_shape@data$LAT
# NUTS_shape2@data$LON <- NUTS_shape@data$LON
# 
# NUTS_fort <- tidy(NUTS_shape)
ggplot() + geom_polygon(data= shp_df, aes(x = long, y = lat, group = group, color = id))

plot(NUTS_shape)
```

