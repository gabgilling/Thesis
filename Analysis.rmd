---
title: "France Opinion Polls MRP"
author: Gabriel Gilling
---

It seems that MEPs are elected at the NUTS level.

Step 1: Estimating sub-national preferences

Country 1: France
https://en.wikipedia.org/wiki/European_Parliament_constituencies_in_France
2014 ELECTION

EB81.3 Attitudes towards the environment

p7fr_r: NUTS 1 Level

Questions about environment: QA1 to QA18

interesting qs:

QA1: how important is the env? 5pt scale
QA2: what important issues in env ... binary
QA3: knowledge about env 5pt scale -- control variable?
QA12 to QA18

Skills and qualifications: QB1 to QB23

qb1: EDUCATION


```{r}
library(haven)
library(dplyr)
library(robustHD)
library(ggplot2)

eb81.3 <- read_dta("/Users/gabgilling/Downloads/ZA5914_v3-0-0.dta")

eb81.3$gender_male <- ifelse(eb81.3$d10 == 2, 1, 0)
eb81.3$age_cat <- with(eb81.3, ifelse(d11 >= 18 & d11 < 25, "Y18-24",
                               ifelse(d11 >= 25 & d11 < 30, "Y25-29",
                               ifelse( d11 >= 30 & d11 < 50, "Y30-49",
                                      ifelse(d11 >= 50 & d11 < 65, "Y50-64",
                                      ifelse(d11 >= 65 & d11 < 85, "Y65-84",
                                      ifelse(d11 >= 85, "Y_GE85",
                                      NA)))))))
                                      
                                      
eb81.3$edu <- eb81.3$qb1

# eb81.3$nuts1 <- with(eb81.3, ifelse(isocntry == "FR", paste("FR", eb81.3$p7fr_r, sep = ""), 
#                       ifelse(isocntry %in% c("GB-GBN", "GB-NIR"), paste("UK", eb81.3$p7gb_r, sep = ""),
#                       ifelse(isocntry == "IT", paste("IT", eb81.3$p7it_r1, sep = ""), NA))))
# 
# eb81.3$nuts2 <- with(eb81.3, ifelse(isocntry == "FR", paste("FR", eb81.3$p7fr, sep = ""), 
#                       ifelse(isocntry %in% c("GB-GBN", "GB-NIR"), paste("UK", eb81.3$p7gb, sep = ""),
#                       ifelse(isocntry == "IT", paste("IT", eb81.3$p7it, sep = ""), NA))))

eb81.3$NUTS_eb <- with(eb81.3, ifelse(isocntry == "FR", paste("FR", eb81.3$p7fr, sep = ""), 
                      ifelse(isocntry %in% c("GB-GBN", "GB-NIR"), paste("UK", eb81.3$p7gb, sep = ""),
                      ifelse(isocntry == "IT", paste("IT", eb81.3$p7it_r1, sep = ""), NA))))


eb81.3_filt <- eb81.3 %>% filter (isocntry %in% c('FR', 'GB-GBN', "GB-NIR", 'IT'))

# drop annoying columns
eb81.3_filt[,grep("q1_", colnames(eb81.3_filt))] <- NULL          
eb81.3_filt[,grep("eu|w", colnames(eb81.3_filt))] <- NULL  


unique(eb81.3_filt$NUTS_eb)

```

Step 2: Census
```{r}
library(data.table)

# nuts_dictionary <- read.csv("https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/nuts_dictionary.csv")
# nuts_fr <- read.csv("https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/NUTS_FR.csv")

census2011_education <- read.csv("https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/census_education.csv")

census2011_education$NUTS2_old <- census2011_education$GEO

reg_preds <- read.csv("https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/regional_predictors.csv")

reg_preds_std <- reg_preds %>% select(gdp_cap,density, area, higher_ed, hhd_income, unemp_pct) %>% robustHD::standardize()

reg_preds_std <- cbind(reg_preds_std, reg_preds %>% select(NUTS, NUTS2_old, NUTS_eb, Region.Name))

census2011_education <- merge(census2011_education, reg_preds_std, by = "NUTS2_old")
# census2011_education <- merge(census2011_education, nuts_fr, by = "NUTS2", all.x = TRUE)

census2011_education$CAS <- NULL
census2011_education$TIME <- NULL
census2011_education$SIE <- NULL
census2011_education$LOC <- NULL
census2011_education$FLAGS <- NULL
census2011_education$FOOTNOTES <- NULL


census2011_education$age_cat <- ifelse(census2011_education$AGE %in% c('Y18', 'Y19', 'Y20-24'), 'Y18-24', 
                                       census2011_education$AGE)

census2011_education$gender_male <- ifelse(census2011_education$SEX == 'M', 1,0 )
census2011_education$edu <- with(census2011_education, ifelse(EDU == 'ED1', 1, ifelse(EDU == 'ED2', 2, ifelse(EDU == 'ED3', 3,
                                    ifelse(EDU == 'ED4', 4, ifelse(EDU == 'ED5', 5, ifelse(EDU == 'ED6', 6, NA)))))))

census2011_education$freq <- census2011_education$VALUE

census2011_education$GEO <- NULL
census2011_education$SEX <- NULL
census2011_education$AGE <- NULL
census2011_education$EDU <- NULL
census2011_education$VALUE <- NULL
```


Step 3: Get regional and country level predictors

https://ec.europa.eu/eurostat/web/regions/data/database
```{r}


```

"We add regional-level predictors from Eurostat to improve the model fit. We retrieve complete
regional data on GDP per capita, area size, population density, tertiary education shares, and
median household income. We use all regional predictors in the BART model, because the
Bayesian back-fitting algorithm does select on the most relevant predictors. However, we have
to select manually some variables for the multi-level regressions to avoid overfitting. Therefore,
we choose a parsimonious set of predictors for the regression-based methods. Here, we account
for the effect of economic conditions on EU trust (Foster and Frieden, 2017), adding the regional
GDP. Moreover, we add a variable measuring whether a region lies in eastern, western, northern or southern Europe (“grand region”)"

## Add country-level predictors
maybe racial / religious predictors

## add marital status 

https://ec.europa.eu/eurostat/web/rural-development/data


## is having more regional predictors than individual predictors OK?

```{r estimate_preferences}
library(rstanarm)

nat_resources <- eb81.3_filt %>% group_by(age_cat, gender_male, edu, NUTS_eb) %>%
  summarise(pro = sum(qa2_1 == 1), against = n() - pro) %>% na.omit()

nat_resources <- merge(nat_resources, reg_preds_std, by = "NUTS_eb")

fit.nat_resources <- stan_glmer(cbind(pro, against) ~ (1|NUTS_eb) + (1|gender_male)  + (1 | age_cat)  + (1|edu) + gdp_cap + density + area + higher_ed + hhd_income + unemp_pct, data = nat_resources, family = binomial(link = "logit"))

print(fit.nat_resources, digits = 3)
```


```{r poststratify}

generate_region_estimates <- function(poststrat, fitted_model){
  
  ## generate state_df
  N <- length(unique(poststrat$NUTS_eb))
  
  region_preferences <- data.frame(
                          region = unique(poststrat$Region.Name),
                          pref = rep(-1, N),
                          sd = rep(-1, N)
)

  for (i in unique(poststrat$Region.Name)) {
    print(i)
    poststrat_region <- poststrat[poststrat$Region.Name == i, ]
    
    posterior_prob_region <- posterior_epred(
      fitted_model,
      # transform = TRUE,
      draws = 1000,
      newdata = as.data.frame(poststrat_region)
    )
    
    poststrat_prob_region <- posterior_prob_region %*% poststrat_region$freq / sum(poststrat_region$freq)

    #This is the estimate for popn in state:
    region_preferences[region_preferences$region == i,]$pref <- round(mean(poststrat_prob_region), 4)
    region_preferences[region_preferences$region == i,]$sd <- round(sd(poststrat_prob_region), 4)
    
  }
  return(region_preferences)
}


nat_resources_prefs <- generate_region_estimates(poststrat = census2011_education %>%  na.omit(), fit.nat_resources)
```


I. Get regional level roll call votes. Need to figure out what roll call votes can be correlated to regional level preferences

votewatch.eu/en/term9-european-parliament-latest-votes.html

https://mepsurvey.eu/data-objects/data/

# T4-0084/1995
```{r}
# install.packages("rjson")
library(rjson)
MEP.data <- fromJSON(file = "/Users/gabgilling/Downloads/ep_votes.json")

grepl("A6", MEP.data[[5]]$title)

cond <- sapply(MEP.data, function(x) grepl("A8-0287/2016", x$title))

dat <- MEP.data[cond]

dat[[1]]$votes$`+`$groups$ALDE[[1]]$mepid

dat[[4]]$title
```

II. Get regional level preferences for FR/UK/GE using EB 

Discrimination in the EU in 2015


III. Poststratify using Eurostat.

```{r}
library(haven)
library(tidyverse)
eb <- read_dta("/Users/gabgilling/Downloads/ZA5998_v2-0-0.dta")
table(eb$nuts)
str(eb)

ess <- read_dta("/Users/gabgilling/Downloads/ESS8e02_1.stata/ESS8e02_1.dta")
ess.f <- ess %>% filter(cntry == "FR") %>% select(regunit, impenv)
ess.f
```

https://en.wikipedia.org/wiki/European_Parliament_constituency#United_Kingdom

https://en.wikipedia.org/wiki/European_Parliament_constituencies_in_France

