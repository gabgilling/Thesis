---
title: "France Opinion Polls MRP"
author: Gabriel Gilling
---

It seems that MEPs are elected at the NUTS level.

Step 1: Estimating sub-national preferences

Country 1: France
https://en.wikipedia.org/wiki/European_Parliament_constituencies_in_France
2014 ELECTION

EB81.3 Attitudes towards the environment

p7fr_r: NUTS 1 Level

Questions about environment: QA1 to QA18

interesting qs:

QA1: how important is the env? 5pt scale
QA2: what important issues in env ... binary
QA3: knowledge about env 5pt scale -- control variable?
QA12 to QA18

Skills and qualifications: QB1 to QB23

qb1: EDUCATION


```{r}
options(dplyr.summarise.inform=F) 
library(haven)
library(dplyr)
library(robustHD)
library(ggplot2)

eb81.3 <- read_dta("/Users/gabgilling/Downloads/ZA5914_v3-0-0.dta")

eb81.3$gender_male <- ifelse(eb81.3$d10 == 2, 1, 0)
eb81.3$age_cat <- with(eb81.3, ifelse(d11 >= 18 & d11 < 25, "Y18-24",
                               ifelse(d11 >= 25 & d11 < 30, "Y25-29",
                               ifelse( d11 >= 30 & d11 < 50, "Y30-49",
                                      ifelse(d11 >= 50 & d11 < 65, "Y50-64",
                                      ifelse(d11 >= 65 & d11 < 85, "Y65-84",
                                      ifelse(d11 >= 85, "Y_GE85",
                                      NA)))))))
                                      
                                      
eb81.3$edu <- eb81.3$qb1

# eb81.3$nuts1 <- with(eb81.3, ifelse(isocntry == "FR", paste("FR", eb81.3$p7fr_r, sep = ""), 
#                       ifelse(isocntry %in% c("GB-GBN", "GB-NIR"), paste("UK", eb81.3$p7gb_r, sep = ""),
#                       ifelse(isocntry == "IT", paste("IT", eb81.3$p7it_r1, sep = ""), NA))))
# 
# eb81.3$nuts2 <- with(eb81.3, ifelse(isocntry == "FR", paste("FR", eb81.3$p7fr, sep = ""), 
#                       ifelse(isocntry %in% c("GB-GBN", "GB-NIR"), paste("UK", eb81.3$p7gb, sep = ""),
#                       ifelse(isocntry == "IT", paste("IT", eb81.3$p7it, sep = ""), NA))))

eb81.3$NUTS_eb <- with(eb81.3, ifelse(isocntry == "FR", paste("FR", eb81.3$p7fr, sep = ""), 
                      ifelse(isocntry %in% c("GB-GBN", "GB-NIR"), paste("UK", eb81.3$p7gb, sep = ""),
                      ifelse(isocntry == "IT", paste("IT", eb81.3$p7it_r1, sep = ""), NA))))


eb81.3_filt <- eb81.3 %>% filter (isocntry %in% c('FR', 'GB-GBN', "GB-NIR", 'IT'))

unique(eb81.3_filt$NUTS_eb)

```

Step 2: Census
```{r}
source("/Users/gabgilling/Documents/GitHub/Thesis/prepare_census.R")
```


Step 3: Get regional and country level predictors

https://ec.europa.eu/eurostat/web/regions/data/database

"We add regional-level predictors from Eurostat to improve the model fit. We retrieve complete
regional data on GDP per capita, area size, population density, tertiary education shares, and
median household income. We use all regional predictors in the BART model, because the
Bayesian back-fitting algorithm does select on the most relevant predictors. However, we have
to select manually some variables for the multi-level regressions to avoid overfitting. Therefore,
we choose a parsimonious set of predictors for the regression-based methods. Here, we account
for the effect of economic conditions on EU trust (Foster and Frieden, 2017), adding the regional
GDP. Moreover, we add a variable measuring whether a region lies in eastern, western, northern or southern Europe (“grand region”)"

## Add country-level predictors
maybe racial / religious predictors

## add marital status 

https://ec.europa.eu/eurostat/web/rural-development/data

https://www.gesis.org/en/eurobarometer-data-service/search-data-access/topics
https://www.kaggle.com/ruslankl/european-union-lgbt-survey-2012?select=LGBT_Survey_Discrimination.csv

## is having more regional predictors than individual predictors OK?

try to minimize amounts of regional predictors, maybe 2-3

```{r estimate_preferences}
library(rstanarm)

eb81.3_filt$protect.env <- ifelse(eb81.3_filt$qa1 %in% c(1,2), 1, ifelse(eb81.3_filt$qa1 %in% c(3,4), 0, NA))

protect.env <- eb81.3_filt %>% group_by(age_cat, gender_male, edu, NUTS_eb) %>%
  summarise(pro = sum(protect.env == 1), against = n() - pro) %>% na.omit()

protect.env <- merge(protect.env, reg_preds_std, by = "NUTS_eb")
protect.env$country <- substr(protect.env$NUTS, 1, 2)

protect.env<- merge(protect.env, nuts_fr %>% select(Constituency, Region.Name), by = "Region.Name", all.x = TRUE)

protect.env$Constituency <- ifelse(is.na(protect.env$Constituency), protect.env$Region.Name, protect.env$Constituency)

fit.protect.env <- stan_glmer(cbind(pro, against) ~ (1|country) + (1|NUTS_eb) + (1|gender_male)  + (1 | age_cat)  + (1|edu) + gdp_cap + higher_ed + hhd_income + unemp_pct, data = protect.env, family = binomial(link = "logit"))

print(fit.protect.env, digits = 3)
```


```{r poststratify}

generate_region_estimates <- function(poststrat, fitted_model){
  
  ## generate state_df
  N <- length(unique(poststrat$Region.Name))
  
  region_preferences <- data.frame(
                          Region.Name = unique(poststrat$Region.Name),
                          constituency = rep("", N),
                          country = rep("", N),
                          pref = rep(-1, N),
                          se = rep(-1, N)
)

  for (i in unique(poststrat$Region.Name)) {
    print(i)
    poststrat_region <- poststrat[poststrat$Region.Name == i, ]
    
    posterior_prob_region <- posterior_epred(
      fitted_model,
      # transform = TRUE,
      draws = 1000,
      newdata = as.data.frame(poststrat_region)
    )
    
    poststrat_prob_region <- posterior_prob_region %*% poststrat_region$freq / sum(poststrat_region$freq)

    #This is the estimate for popn in state:
    region_preferences[region_preferences$Region.Name == i,]$pref <- round(mean(poststrat_prob_region), 4)
    region_preferences[region_preferences$Region.Name == i,]$se <- round(sd(poststrat_prob_region), 4)
    region_preferences[region_preferences$Region.Name == i,]$country <- unique(poststrat_region$country)
    region_preferences[region_preferences$Region.Name == i,]$constituency <- unique(poststrat_region$Constituency)
  }
  return(region_preferences)
}


protect.env_prefs <- generate_region_estimates(poststrat = census2011_education %>%  na.omit(), fit.protect.env)

protect.envs_prefs.r <- protect.env_prefs %>% group_by(constituency, country) %>% summarise(pref = mean(pref), se = mean(se))


ggplot(protect.envs_prefs.r, aes(x= constituency, y = pref, group = 1, color = country)) + geom_point() + 
  geom_errorbar(aes(ymin= pref - se, ymax= pref + se), width=0) + 
  theme_classic() +
  ylim(0.6, 1) + 
  ggtitle("") +
  theme(axis.text.x = element_text(angle = 90))
```


I. Get regional level roll call votes. Need to figure out what roll call votes can be correlated to regional level preferences

votewatch.eu/en/term9-european-parliament-latest-votes.html

https://mepsurvey.eu/data-objects/data/

# MEP Survey data

```{r}
mep.ids <- read.csv("https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/mep_data_with_IDs.csv")

mep.ids$date_begin <- as.Date(mep.ids$date_begin, format = "%m/%d/%y")
mep.ids$date_end <- as.Date(mep.ids$date_end, format = "%m/%d/%y")
mep.ids$constituency <- with(mep.ids, ifelse(constituency %in% 
          c("Massif-central–Central", "Massif Central-Centre",  "Massif central-Centre","Massif central – Centre"),
          "Massif-central-Centre", constituency))

mep.ids$constituency <- with(mep.ids, ifelse(constituency %in% c("Île-de-France", "Ile-de-France"), "Ile de France" , constituency))

mep.ids$Parliament <- with(mep.ids, ifelse(date_begin >= "2004-07-20" & date_end <= "2009-06-07", 6, 
                                    ifelse(date_begin > "2009-06-07" & date_end <= "2014-07-14", 7,
                                    ifelse(date_begin >= "2014-07-15" & date_end <= "2020-01-01", 8, Parliament))))

# mep.ids$constituency <- with(mep.ids, ifelse(constituency == "Est", "East France" , constituency))
# mep.ids$constituency <- with(mep.ids, ifelse(constituency == "Sud-Ouest", "South-West France" , constituency))
# mep.ids$constituency <- with(mep.ids, ifelse(constituency %in% c("Ouest", "West"), "West France" , constituency))
# mep.ids$constituency <- with(mep.ids, ifelse(constituency %in% c("Nord-Ouest", ), "North-West France" , constituency))
# mep.ids$constituency <- with(mep.ids, ifelse(constituency %in% c("Nord-Ouest"), "North-West France" , constituency))

```

# T4-0084/1995

Final votes tabulated as "Proposition"
Amendments - "Am"

tabulate parliament group activities as additional control

need to adjust for fact that some MEPs were not in parliament at that time

```{r}
# install.packages("rjson")
library(rjson)
MEP.data <- fromJSON(file = "/Users/gabgilling/Dropbox/QMSS/Fall 2020/Thesis/Data/ep_votes.json")

grepl("A6", MEP.data[[5]]$title)

cond <- sapply(MEP.data, function(x) grepl("A8-0287/2016", x$title))

cond <- sapply(MEP.data, function(x) grepl("envir", x$title))

cond.ts <- sapply(MEP.data, function(x) grepl("2018-11", x$ts))

#A8-0354/2018 CO2 emission performance standards for new heavy duty vehicles ***I	
cond1 <- sapply(MEP.data, function(x) grepl("A8-0354/2018", x$title))
dat <- MEP.data[cond1]
cond2 <- sapply(dat, function(x) grepl("Proposition", x$title))
A8.0354 <- dat[cond2][[1]]

#A8-0249/2015 reduction of national emissions of certain atmospheric pollutants
#https://www.europarl.europa.eu/doceo/document/TA-8-2016-0438_EN.html

cond1 <- sapply(MEP.data, function(x) grepl("A8-0249/2015", x$title))
dat <- MEP.data[cond1]
cond2 <- sapply(dat, function(x) grepl("Résolution", x$title))
A8.0249 <- dat[cond2][[1]]

#A8-0317/2018 
#reduction of the impact of certain plastic products on the environment
#https://www.europarl.europa.eu/doceo/document/A-8-2018-0317_EN.html

# A7-0294/2012
# establishment of a Programme for the Environment and Climate Action (LIFE)
# https://www.europarl.europa.eu/doceo/document/A-7-2012-0294_EN.html?redirect

# https://eur-lex.europa.eu/legal-content/en/HIS/?uri=CELEX:32008L0050
```

```{r}

count_votes <- function(resolution_name, col_name){
  mep.ids[col_name] <- 0
  # print(get(resolution_name))
  resolution = get(resolution_name)
  for (i in resolution$votes$`+`$groups){
    for (id in unname(unlist(i))){
      if (id %in% unique(mep.ids$ID)){
        mep.ids[mep.ids$ID == id,][col_name] <- 1
      }
    }
  }
  
  for (i in resolution$votes$`-`$groups){
    for (id in unname(unlist(i))){
      if (id %in% unique(mep.ids$ID)){
        mep.ids[mep.ids$ID == id,][col_name]- -1
      }
    }
  }
  return(mep.ids)
}

mep.ids$env1 <- 0
mep.ids$env2 <- 0

mep.ids <- count_votes(resolution_name = "A8.0249", "env2")
mep.ids <- count_votes(resolution_name = "A8.0354", "env1")

mep.ids$env1 <- with(mep.ids, ifelse(Parliament != 8, NA, env1))
mep.ids$env2 <- with(mep.ids, ifelse(Parliament != 8, NA, env2))

```


```{r}
ggplot(mep.ids %>% group_by(constituency, Parliament, country) %>% 
       summarise(mep_pref = mean(env1+env2), mep_se = sd(env1+env2) / sqrt(length(env1+env2))) %>% na.omit(), 
       aes(x = constituency, y = mep_pref, color = country)) + 
  geom_point() + 
  geom_errorbar(aes(ymin= mep_pref - mep_se, ymax= mep_pref + mep_se), width=0) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90))
```

```{r warning=FALSE}
library(rgdal)
library(broom)
library(maptools)
library(ggplot2)

# install.packages('rgeos', type='source')
# install.packages('rgdal', type='source')

NUTS_shape = readOGR(dsn = "/Users/gabgilling/Desktop/NUTS_2013_01M_SH/data/")

NUTS_shape2 = readOGR(dsn = "/Users/gabgilling/Desktop/NUTS_2013_01M_SH/data/", layer = "NUTS_RG_01M_2013")

nuts <- readOGR(dsn = "/Users/gabgilling/Desktop/NUTS_2013_01M_SH/data/NUTS_RG_01M_2013.shp")

nuts <- nuts[nuts$STAT_LEVL_ %in% c(1,2),]
nuts <- nuts[grepl("FR|UK|IT",nuts$NUTS_ID),]

# plot(nuts)
shp_df <- fortify(nuts, region = "NUTS_ID")

shp_df <- shp_df %>% filter(id %in% c("FR", "UK", "IT"))

# NUTS_shape2@data$LAT <- NUTS_shape@data$LAT
# NUTS_shape2@data$LON <- NUTS_shape@data$LON
# 
# NUTS_fort <- tidy(NUTS_shape)
ggplot() + geom_polygon(data= shp_df, aes(x = long, y = lat, group = group, color = id))

plot(NUTS_shape)
```

