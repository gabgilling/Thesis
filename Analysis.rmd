---
title: "France Opinion Polls MRP"
author: Gabriel Gilling
---

It seems that MEPs are elected at the NUTS level.

Step 1: Estimating sub-national preferences

Country 1: France
https://en.wikipedia.org/wiki/European_Parliament_constituencies_in_France
2014 ELECTION

EB81.3 Attitudes towards the environment

p7fr_r: NUTS 1 Level

Questions about environment: QA1 to QA18

interesting qs:

QA1: how important is the env? 5pt scale
QA2: what important issues in env ... binary
QA3: knowledge about env 5pt scale -- control variable?
QA12 to QA18

Skills and qualifications: QB1 to QB23

qb1: EDUCATION


```{r}
library(haven)
library(dplyr)

eb81.3 <- read_dta("/Users/gabgilling/Downloads/ZA5914_v3-0-0.dta")

eb81.3$gender_male <- ifelse(eb81.3$d10 == 2, 1, 0)
eb81.3$age_cat <- ifelse(eb81.3$d10 == 2, 1, 0)
eb81.3$edu <- eb81.3$qb1

eb81.3$nuts1 <- with(eb81.3, ifelse(isocntry == "FR", paste("FR", eb81.3$p7fr_r, sep = ""), 
                      ifelse(isocntry %in% c("GB-GBN", "GB-NIR"), paste("GB", eb81.3$p7gb_r, sep = ""),
                      ifelse(isocntry %in% c("DE-W", "DE-E"), paste("DE", eb81.3$p7de_r, sep = ""),
                      ifelse(isocntry == "IT", paste("IT", eb81.3$p7it, sep = ""), NA)))))


eb81.3_filt <- eb81.3 %>% filter (isocntry %in% c('FR', 'GB-GBN', "DE-W", "DE-E", "GB-NIR", 'IT'))

# drop annoying columns
eb81.3_filt[,grep("q1_", colnames(eb81.3_filt))] <- NULL          
eb81.3_filt[,grep("eu|w", colnames(eb81.3_filt))] <- NULL  



colnames(eb81.3_filt)
unique(eb81.3_filt$nuts1)

```

Step 2: Census
```{r}
library(data.table)

nuts_dictionary <- read.csv("https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/nuts_dictionary.csv")
nuts_fr <- read.csv("https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/NUTS_FR.csv")


census2011_education <- read.csv("https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/census_education.csv")

census2011_education$NUTS2 <- census2011_education$GEO

census2011_education <- merge(census2011_education, nuts_fr, by = "NUTS2")


census2011_education$CAS <- NULL
census2011_education$TIME <- NULL
census2011_education$SIE <- NULL
census2011_education$LOC <- NULL
census2011_education$FLAGS <- NULL
census2011_education$FOOTNOTES <- NULL


census2011_education$age_cat <- ifelse(census2011_education$AGE %in% c('Y18', 'Y19', 'Y20-24'), 'Y18-24', 
                                       census2011_education$AGE)
census2011_education$gender_male <- ifelse(census2011_education$SEX == 'M', 1,0 )
census2011_education$edu <- with(census2011_education, ifelse(EDU == 'ED1', 1, ifelse(EDU == 'ED2', 2, ifelse(EDU == 'ED3', 3,
                                    ifelse(EDU == 'ED4', 4, ifelse(EDU == 'ED5', 5, ifelse(EDU == 'ED6', 6, EDU)))))))

unique(census2011_education$nuts1)
```


Step 3: Get regional and country level predictors

https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/regional_predictors.csv
```{r}
reg_preds <- read.csv("https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/regional_predictors.csv")
```

"We add regional-level predictors from Eurostat to improve the model fit. We retrieve complete
regional data on GDP per capita, area size, population density, tertiary education shares, and
median household income. We use all regional predictors in the BART model, because the
Bayesian back-fitting algorithm does select on the most relevant predictors. However, we have
to select manually some variables for the multi-level regressions to avoid overfitting. Therefore,
we choose a parsimonious set of predictors for the regression-based methods. Here, we account
for the effect of economic conditions on EU trust (Foster and Frieden, 2017), adding the regional
GDP. Moreover, we add a variable measuring whether a region lies in eastern, western, northern or southern Europe (“grand region”)"

## Add country-level predictors
maybe racial / religious predictors

## add marital status 

https://ec.europa.eu/eurostat/web/rural-development/data

```{r}
library(rstanarm)

nat_resources <- eb81.3_filt %>% group_by(age_cat, gender_male, edu, nuts1) %>%
  summarise(pro = sum(qa2_1 == 1), against = n() - pro) %>% na.omit

fit.nat_resources <- stan_glmer(cbind(pro, against) ~ (1|nuts1) + (1|gender_male)  + (1 | age_cat)  + (1|edu) + p_tot_catholic_adh + p_evan_mormon_adh, data = sup.money, family = binomial(link = "logit"), 
                            control = list(adapt_delta = 0.99), refresh = 0)
```


I. Get regional level roll call votes. Need to figure out what roll call votes can be correlated to regional level preferences

votewatch.eu/en/term9-european-parliament-latest-votes.html


# T4-0084/1995
```{r}
# install.packages("rjson")
library(rjson)
MEP.data <- fromJSON(file = "/Users/gabgilling/Downloads/ep_votes.json")

grepl("A6", MEP.data[[5]]$title)

cond <- sapply(MEP.data, function(x) grepl("A8-0287/2016", x$title))

dat <- MEP.data[cond]

dat[[1]]$votes$`+`$groups$ALDE[[1]]$mepid

dat[[4]]$title
```

II. Get regional level preferences for FR/UK/GE using EB 

Discrimination in the EU in 2015


III. Poststratify using Eurostat.

```{r}
library(haven)
library(tidyverse)
eb <- read_dta("/Users/gabgilling/Downloads/ZA5998_v2-0-0.dta")
table(eb$nuts)
str(eb)

ess <- read_dta("/Users/gabgilling/Downloads/ESS8e02_1.stata/ESS8e02_1.dta")
ess.f <- ess %>% filter(cntry == "FR") %>% select(regunit, impenv)
ess.f
```

https://en.wikipedia.org/wiki/European_Parliament_constituency#United_Kingdom

https://en.wikipedia.org/wiki/European_Parliament_constituencies_in_France

## France

2004
2009
2014

North-West FRE + FRD
Normandy FRD
FR23   Haute-Normandie
FR25   Basse-Normandie

Haut-de-France = Nord-Pas-de-Calais + Picardy FRE 
FR30   Nord - Pas-de-Calais
FR22   Picardie

West	-- FR5
Pays de la Loire, Brittany, Poitou-Charentes
FR51   Pays de la Loire
FR52   Bretagne
FR53   Poitou-Charentes

East	FRC + FRF
Grand Est, FRC
Alsace, Champagne-Ardenne,Lorraine
FR42   Alsace
FR21   Champagne-Ardenne
FR41   Lorraine
and Bourgogne-Franche-Comté. FRF
FR26   Bourgogne
FR43   Franche-Comté

South-West
Aquitaine FRI1
FR61   Aquitaine
Languedoc-Roussillon-Midi-Pyrénées FRJ
FR81   Languedoc-Roussillon
FR62   Midi-Pyrénées

South-East
Corsica FRM
FR83   Corse [not covered]

Provence-Alpes-Côte d’Azur FRL
FR82   Provence-Alpes-Côte d'Azur
Rhône-Alpes	FRK2
FR71   Rhône-Alpes

Massif central–Centre
Centre-Val de Loire FRB
FR24   Centre [FR
Auvergne FRK1
FR72   Auvergne
Limousin FRI2
FR63   Limousin

Île-de-France FR1
FR10

Overseas	

```{r}

# eb83.3fr <- eb %>% filter(nuts %in% c("FR10", "FR21", "FR22", "FR23", "FR24", "FR25", "FR26", "FR30", 
# "FR41", "FR42", "FR43",  "FR51",  "FR52",  "FR53",  "FR61",  "FR62"))

eb83.3fr <- eb %>% filter(country == 1) #france numbah 1



```


