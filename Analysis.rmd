---
title: "France Opinion Polls MRP"
author: Gabriel Gilling
---

It seems that MEPs are elected at the NUTS level.

Step 1: Estimating sub-national preferences

Country 1: France
https://en.wikipedia.org/wiki/European_Parliament_constituencies_in_France
2014 ELECTION

EB81.3 Attitudes towards the environment

p7fr_r: NUTS 1 Level

Questions about environment: QA1 to QA18

interesting qs:

QA1: how important is the env? 5pt scale
QA2: what important issues in env ... binary
QA3: knowledge about env 5pt scale -- control variable?
QA12 to QA18


QA18!
Skills and qualifications: QB1 to QB23

qb1: EDUCATION


```{r}
options(dplyr.summarise.inform=F) 
library(haven)
library(dplyr)
library(robustHD)
library(ggplot2)
library(forcats)


#v668 IT NUTS 1, v660 FR NUTS 2, v673 NUTS1 UK
#v601 gender v602 age v596 ms

unique(eb75.2$v596)
```

Step 2: Census
```{r}
# census2011_education <- read.csv("https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/census_edu_predictors.csv", header = T)

source("https://raw.githubusercontent.com/gabgilling/Thesis/master/prepare_census.R")
census2011_ms <- read.csv("https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/census_ms_predictors.csv", header = T)
```


Step 3: Get regional and country level predictors

https://ec.europa.eu/eurostat/web/regions/data/database

## add marital status 

https://ec.europa.eu/eurostat/web/rural-development/data

https://www.gesis.org/en/eurobarometer-data-service/search-data-access/topics
https://www.kaggle.com/ruslankl/european-union-lgbt-survey-2012?select=LGBT_Survey_Discrimination.csv

## is having more regional predictors than individual predictors OK?

try to minimize amounts of regional predictors, maybe 2-3

```{r estimate_preferences}
library(rstanarm)
set.seed(1010)



eb75.2 %>% group_by(NUTS_eb) %>% summarise(mean(eu.leg, na.rm = T))



rbind(eb75.2 %>% select(protect.env, age_cat2, gender_male, ms, NUTS_eb), eb81.3 %>% select(protect.env, age_cat2, gender_male, ms, NUTS_eb)) %>% group_by(age_cat2, gender_male, ms, NUTS_eb) %>%
  summarise(pro = sum(get(var_name) == 1), against = n() - pro) %>% na.omit()
```


```{r}


fit_var_logit <- function(survey_df = c(), var_name){
  # print(length(survey_df))
  if (length(survey_df) >= 2){
    
    temp <- get(survey_df[1]) %>% select(var_name, age_cat2, gender_male, ms, NUTS_eb)
    for (i in 2:length(survey_df)){
      temp <- rbind(temp, get(survey_df[i]) %>% select(var_name, age_cat2, gender_male, ms, NUTS_eb))
    }
  } else {
    temp = get(survey_df)
  }
  

  temp <- merge(temp, reg_preds_std, by = "NUTS_eb")
    
  temp$country <- substr(temp$NUTS, 1, 2)
  temp <- merge(temp, nuts_fr %>% select(Constituency, Region.Name), by = "Region.Name", all.x = TRUE)
  temp$Constituency <- ifelse(is.na(temp$Constituency), temp$Region.Name, temp$Constituency)
  
  temp <- temp %>% group_by(age_cat2, gender_male, ms, Constituency, country, gdp_cap, 
                            higher_ed,hhd_income, unemp_pct) %>%
  summarise(pro = sum(get(var_name) == 1), against = n() - pro) %>% na.omit()
  
  set.seed(1010)

  return(stan_glmer(cbind(pro, against) ~ (1|country) + (1|Constituency) + (1 | age_cat2)  + (1|ms) + gdp_cap + higher_ed + hhd_income + unemp_pct + gender_male, data = temp, family = binomial(link = "logit"), refresh= 0, 
                    chains = 4, cores=  4, adapt_delta= 0.99))

}


colnames(eb81.3)
fit.env.important.813 <- fit_var_logit(survey_df = c("eb81.3"), var_name = "env.important")
fit.eu.enf.env.813 <- fit_var_logit(survey_df = "eb81.3", var_name = "eu.enf")
fit.eu.leg.env.813 <- fit_var_logit(survey_df = c("eb81.3"), var_name = "eu.leg")
fit.eu.asst.env.813 <- fit_var_logit(survey_df = c("eb81.3"), var_name = "eu.asst")
fit.eu.fund.env.813 <- fit_var_logit(survey_df = c("eb81.3"), var_name = "eu.fund")
fit.cooperation.env.813 <- fit_var_logit(survey_df = c("eb81.3"), var_name = "cooperation")
fit.envorecon.env.813 <- fit_var_logit(survey_df = c("eb81.3"), var_name = "envorecon")

colnames(eb75.2)
fit.env.important.752 <- fit_var_logit(survey_df = c("eb75.2"), var_name = "env.important")
fit.eu.leg.752 <- fit_var_logit(survey_df = c("eb75.2"), var_name = "eu.leg")
fit.eu.asst.752 <- fit_var_logit(survey_df = c("eb75.2"), var_name = "eu.asst")
fit.eu.fund.752<- fit_var_logit(survey_df = c("eb75.2"), var_name = "eu.fund")
fit.cooperation.752 <- fit_var_logit(survey_df = c("eb75.2"), var_name = "cooperation")
fit.envorecon.752 <- fit_var_logit(survey_df = c("eb75.2"), var_name = "envorecon")

colnames(eb62.1)
fit.envimportant1.621 <- fit_var_logit(survey_df = c("eb62.1"), var_name = "envimportant1")
fit.envimportant2.621  <- fit_var_logit(survey_df = c("eb62.1"), var_name = "envimportant2")
fit.stricterreg.621  <- fit_var_logit(survey_df = c("eb62.1"), var_name = "stricterreg")
fit.enfreg.621 <- fit_var_logit(survey_df = c("eb62.1"), var_name = "enfreg")
fit.highertax.621  <- fit_var_logit(survey_df = c("eb62.1"), var_name = "highertax")
fit.supNGOs.621  <- fit_var_logit(survey_df = c("eb62.1"), var_name = "supNGOs")
fit.financialincentives.621 <- fit_var_logit(survey_df = c("eb62.1"), var_name = "financialincentives")

colnames(eb68.2)

fit.682 <- list()

generate_estimates <- function(survey_df){
  excl <- c("gender_male", "age_cat2","isocntry" , "ms" ,"NUTS_eb", "year","parliament")
  my_list <- list()
  i <- 1
  for (col in colnames(get(survey_df))[!colnames(get(survey_df)) %in% excl]){
    print(col)
    my_list[[i]] <- fit_var_logit(survey_df = survey_df, var_name = col)
    i <- i + 1
  }
  return(my_list)
}

fit.692 <- generate_estimates("eb69.2")
fit.813 <- generate_estimates("eb81.3")
fit.752 <- generate_estimates("eb75.2")
fit.621 <- generate_estimates("eb62.1")
fit.682 <- generate_estimates("eb68.2")
fit.711 <- generate_estimates("eb71.1")
fit.721 <- generate_estimates("eb72.1")
fit.752 <- generate_estimates("eb75.2")

fit.802 <- generate_estimates("eb80.2")
fit.834 <- generate_estimates("eb83.4")

fit.871 <- generate_estimates("eb87.1")
fit.881 <- generate_estimates("eb88.1")




l <- readRDS("fit.692.rds")

set.seed(1011)
fit.692[[8]] <- fit_var_logit(survey_df = c("eb69.2"), var_name = "ghgtarget")

# fit.env.important.682 <- fit_var_logit(survey_df = c("eb68.2"), var_name = "env.important")
# fit.envoverecon1.682  <- fit_var_logit(survey_df = c("eb68.2"), var_name = "envoverecon1")
# fit.envoverecon2.682  <- fit_var_logit(survey_df = c("eb68.2"), var_name = "envoverecon2")
# fit.cooperation.682  <- fit_var_logit(survey_df = c("eb68.2"), var_name = "envoverecon1")
# fit.stricterreg.682  <- fit_var_logit(survey_df = c("eb68.2"), var_name = "stricterreg")
# fit.enfreg.682 <- fit_var_logit(survey_df = c("eb68.2"), var_name = "enfreg")
# fit.highertax.682  <- fit_var_logit(survey_df = c("eb68.2"), var_name = "highertax")
# fit.eu.fund.682  <- fit_var_logit(survey_df = c("eb68.2"), var_name = "eu.fund")
# fit.heavierfines.682 <- fit_var_logit(survey_df = c("eb68.2"), var_name = "heavierfines")
# fit.financialincentives.682 <- fit_var_logit(survey_df = c("eb68.2"), var_name = "financialincentives")

# protect.env <- eb81.3_filt %>% group_by(age_cat2, gender_male, ms, NUTS_eb) %>%
#   summarise(pro = sum(protect.env == 1), against = n() - pro) %>% na.omit()
# 
# protect.env <- merge(protect.env, reg_preds_std, by = "NUTS_eb")
# protect.env$country <- substr(protect.env$NUTS, 1, 2)
# protect.env<- merge(protect.env, nuts_fr %>% select(Constituency, Region.Name), by = "Region.Name", all.x = TRUE)
# protect.env$Constituency <- ifelse(is.na(protect.env$Constituency), protect.env$Region.Name, protect.env$Constituency)


print(fit.protect.env, digits = 3)
```

```{r poststratify}

generate_region_estimates <- function(poststrat, fitted_model){
  
  ## generate state_df
  N <- length(unique(poststrat$Region.Name))
  
  region_preferences <- data.frame(
                          Region.Name = unique(poststrat$Region.Name),
                          constituency = rep("", N),
                          country = rep("", N),
                          pref = rep(-1, N),
                          se = rep(-1, N)
)

  for (i in unique(poststrat$Region.Name)) {
    # print(i)
    poststrat_region <- poststrat[poststrat$Region.Name == i, ]
    
    posterior_prob_region <- posterior_epred(
      fitted_model,
      # transform = TRUE,
      draws = 1000,
      newdata = as.data.frame(poststrat_region)
    )
    
    poststrat_prob_region <- posterior_prob_region %*% poststrat_region$freq / sum(poststrat_region$freq)

    #This is the estimate for popn in state:
    region_preferences[region_preferences$Region.Name == i,]$pref <- round(mean(poststrat_prob_region), 4)
    region_preferences[region_preferences$Region.Name == i,]$se <- round(sd(poststrat_prob_region), 4)
    region_preferences[region_preferences$Region.Name == i,]$country <- unique(poststrat_region$country)
    region_preferences[region_preferences$Region.Name == i,]$constituency <- unique(poststrat_region$Constituency)
  }
  
  return(region_preferences %>% group_by(constituency, country) %>% summarise(pref = mean(pref), se = mean(se)))
}


protect.env_prefs <- generate_region_estimates(poststrat = census2011_ms %>%  na.omit(), fit.protect.env)
envorecon_prefs <- generate_region_estimates(poststrat = census2011_ms %>%  na.omit(), fit.envorecon)
cooperation_prefs <- generate_region_estimates(poststrat = census2011_ms %>%  na.omit(), fit.cooperation)
eu.asst_prefs <- generate_region_estimates(poststrat = census2011_ms %>%  na.omit(), fit.eu.asst)
eu.enf_prefs <- generate_region_estimates(poststrat = census2011_ms %>%  na.omit(), fit.eu.enf)
eu.fund_prefs <- generate_region_estimates(poststrat = census2011_ms %>%  na.omit(), fit.eu.fund)
eu.leg_prefs <- generate_region_estimates(poststrat = census2011_ms %>%  na.omit(), fit.eu.leg)

agg_prefs <- rbind(protect.env_prefs,envorecon_prefs,cooperation_prefs,eu.asst_prefs,eu.enf_prefs,eu.fund_prefs,eu.leg_prefs) %>% group_by(constituency, country) %>%summarise(mean_pref = mean(pref), mean_se = mean(se))


env_prefs_plot <- ggplot(agg_prefs,
                         aes(x= reorder(constituency, mean_pref), y = mean_pref, color = country)) + 
  geom_point() + 
  geom_errorbar(aes(ymin= mean_pref - mean_se, ymax= mean_pref + mean_se), width=0) + 
  theme_classic() +
  # ylim(0.6, 1) + 
  ggtitle("") +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Constituency", y = "Mean Preference")

env_prefs_plot

# ggsave("/Users/gabgilling/Documents/GitHub/Thesis/Plots/env_prefs_plot.jpg")

```

```{r}
ggplot(protect.envs_prefs.r,
  aes(x= reorder(constituency, pref), y = pref, color = country)) + 
  geom_point() + 
  geom_errorbar(aes(ymin= pref - se, ymax= pref + se), width=0) + 
  theme_classic() +
  # ylim(0.6, 1) + 
  ggtitle("") +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Constituency", y = "Mean Preference")

```

```{r}
ggplot(protect.envs_prefs.r2,
  aes(x= reorder(constituency, pref), y = pref, color = country)) + 
  geom_point() + 
  geom_errorbar(aes(ymin= pref - se, ymax= pref + se), width=0) + 
  theme_classic() +
  # ylim(0.6, 1) + 
  ggtitle("") +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Constituency", y = "Mean Preference")
```

I. Get regional level roll call votes. Need to figure out what roll call votes can be correlated to regional level preferences

votewatch.eu/en/term9-european-parliament-latest-votes.html

https://mepsurvey.eu/data-objects/data/

# MEP Survey data

```{r}
mep.ids <- read.csv("https://raw.githubusercontent.com/gabgilling/Thesis/master/Data/mep_data_with_IDs.csv")
```

# T4-0084/1995

Final votes tabulated as "Proposition"
Amendments - "Am"

tabulate parliament group activities as additional control

need to adjust for fact that some MEPs were not in parliament at that time

```{r}
# install.packages("rjson")
library(rjson)
MEP.data <- fromJSON(file = "/Users/gabgilling/Dropbox/QMSS/Fall 2020/Thesis/Data/ep_votes.json")

grepl("A6", MEP.data[[5]]$title)

cond <- sapply(MEP.data, function(x) grepl("A8-0287/2016", x$title))

cond <- sapply(MEP.data, function(x) grepl("envir", x$title))

cond.ts <- sapply(MEP.data, function(x) grepl("2018-11", x$ts))

#A8-0354/2018 CO2 emission performance standards for new heavy duty vehicles ***I	
cond1 <- sapply(MEP.data, function(x) grepl("A8-0354/2018", x$title))
dat <- MEP.data[cond1]
cond2 <- sapply(dat, function(x) grepl("Proposition", x$title))
A8.0354 <- dat[cond2][[1]]

#A8-0249/2015 reduction of national emissions of certain atmospheric pollutants
#https://www.europarl.europa.eu/doceo/document/TA-8-2016-0438_EN.html

cond1 <- sapply(MEP.data, function(x) grepl("A8-0249/2015", x$title))
dat <- MEP.data[cond1]
cond2 <- sapply(dat, function(x) grepl("RÃ©solution", x$title))
A8.0249 <- dat[cond2][[1]]

#A8-0317/2018 
#reduction of the impact of certain plastic products on the environment
#https://www.europarl.europa.eu/doceo/document/A-8-2018-0317_EN.html

# A7-0294/2012
# establishment of a Programme for the Environment and Climate Action (LIFE)
# https://www.europarl.europa.eu/doceo/document/A-7-2012-0294_EN.html?redirect

# https://eur-lex.europa.eu/legal-content/en/HIS/?uri=CELEX:32008L0050
```

```{r}

count_votes <- function(resolution_name, col_name){
  mep.ids[col_name] <- 0
  # print(get(resolution_name))
  resolution = get(resolution_name)
  for (i in resolution$votes$`+`$groups){
    for (id in unname(unlist(i))){
      if (id %in% unique(mep.ids$ID)){
        mep.ids[mep.ids$ID == id,][col_name] <- 1
      }
    }
  }
  
  for (i in resolution$votes$`-`$groups){
    for (id in unname(unlist(i))){
      if (id %in% unique(mep.ids$ID)){
        mep.ids[mep.ids$ID == id,][col_name]- -1
      }
    }
  }
  return(mep.ids)
}

mep.ids$env1 <- 0
mep.ids$env2 <- 0

mep.ids <- count_votes(resolution_name = "A8.0249", "env2")
mep.ids <- count_votes(resolution_name = "A8.0354", "env1")

mep.ids$env1 <- with(mep.ids, ifelse(Parliament != 8, NA, env1))
mep.ids$env2 <- with(mep.ids, ifelse(Parliament != 8, NA, env2))

```


```{r}
ggplot(mep.ids %>% group_by(constituency, Parliament, country) %>% 
       summarise(mep_pref = mean(env1+env2), mep_se = sd(env1+env2) / sqrt(length(env1+env2))) %>% na.omit(), 
       aes(x = constituency, y = mep_pref, color = country)) + 
  geom_point() + 
  geom_errorbar(aes(ymin= mep_pref - mep_se, ymax= mep_pref + mep_se), width=0) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90))
```

```{r warning=FALSE}
library(rgdal)
library(broom)
library(maptools)
library(ggplot2)

# install.packages('rgeos', type='source')
# install.packages('rgdal', type='source')

NUTS_shape = readOGR(dsn = "/Users/gabgilling/Desktop/NUTS_2013_01M_SH/data/")

NUTS_shape2 = readOGR(dsn = "/Users/gabgilling/Desktop/NUTS_2013_01M_SH/data/", layer = "NUTS_RG_01M_2013")

nuts <- readOGR(dsn = "/Users/gabgilling/Desktop/NUTS_2013_01M_SH/data/NUTS_RG_01M_2013.shp")

nuts <- nuts[nuts$STAT_LEVL_ %in% c(1,2),]
nuts <- nuts[grepl("FR|UK|IT",nuts$NUTS_ID),]

# plot(nuts)
shp_df <- fortify(nuts, region = "NUTS_ID")

shp_df <- shp_df %>% filter(id %in% c("FR", "UK", "IT"))

# NUTS_shape2@data$LAT <- NUTS_shape@data$LAT
# NUTS_shape2@data$LON <- NUTS_shape@data$LON
# 
# NUTS_fort <- tidy(NUTS_shape)
ggplot() + geom_polygon(data= shp_df, aes(x = long, y = lat, group = group, color = id))

plot(NUTS_shape)
```

